<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>mqtt</title>
  <script src="mqtt.min.js"></script>
  <style type="text/css">
    .btn {
      margin-top: 10px;
      margin-left: 10px;
      min-width: 150px;
      min-height: 35px;
    }
    .text {
      margin-top: 10px;
      margin-left: 10px;
      min-width: 30px;
      min-height: 25px;
      max-width: 75px;
      text-align: center;
    }

  </style>
</head>
<body>
      <h3>玉双路5号电源管理</h3>
      <h4 style="color:blue;">wss://broker.emqx.io:8084/mqtt</h4>
      <div>
        <input type="button" class="btn" value="打开电源" style="color:blue;" onclick="publish_mac_address('kimkat_and_gobaba_pin', 'on');">
        <input type="button" class="btn" value="关闭电源" style="color:blue;" onclick="publish_mac_address('kimkat_and_gobaba_pin', 'off');">
      </div>
      <div>
        <input type="button" class="btn" value="切换状态" onclick="publish_mac_address('kimkat_and_gobaba_pin', 'toggle');">
        <input type="button" class="btn" value="获取状态" onclick="publish_mac_address('kimkat_and_gobaba_pin', 'status');">
      </div>
      <div>
        <span style="margin-left: 10px;">倒计时:</span>
        <input type="text" class="text" id="timer_input" value="0">
        <input type="button" class="btn" value="设置倒计时(分)" onclick="set_timer();">
      </div>
      <hr>
      <div id = "display" style="margin-top: 20px;margin-left: 10px;"></div>
<script>
    const clientId = 'mqttjs_' + Math.random().toString(16).substr(2, 8)
    const host = 'wss://broker.emqx.io:8084/mqtt'
    const options = {
      keepalive: 60*3,
      clientId: clientId,
      protocolId: 'MQTT',
      protocolVersion: 4,
      clean: true,
      reconnectPeriod: 1000,
      connectTimeout: 30 * 1000,
      will: {
        topic: 'WillMsg',
        payload: 'Connection Closed abnormally..!',
        qos: 0,
        retain: false
      },
    }
    console.log('Connecting mqtt client')
    const client = mqtt.connect(host, options);

    client.subscribe('kimkat_and_gobaba_pin_response', { qos: 0 }, function (error, granted) {
      if (error) {
        console.log(error);
      } else {
        console.log(`${granted[0].topic} was subscribed`);
        publish_mac_address('kimkat_and_gobaba_pin', 'status');
      }
    })

    client.subscribe('kimkat_and_gobaba_pin_set_timer_min', { qos: 0 }, function (error, granted) {
      if (error) {
        console.log(error);
      } else {
        console.log(`${granted[0].topic} was subscribed`);
      }
    })

    client.on('message', function (topic, payload, packet) {
      console.log(`Topic: ${topic}, Message: ${payload.toString()}, QoS: ${packet.qos}`);      
      //处理收到的消息
      var response = JSON.parse(payload.toString());
      console.log(response);
      //电源开关状态
      document.querySelector("#display").innerHTML = '<p><strong>1、目前状态:</strong> ' + (response.status > 0 ? "开" : "关") + "</p>";   
      document.querySelector("#display").innerHTML += '<p><strong>2、开机时间:</strong> ' + usec_to_hour_min_sec(response.uptime_usec) + "</p>";
      document.querySelector("#display").innerHTML += '<p><strong>3、状态持续时间:</strong> ' + usec_to_hour_min_sec(response.delta_time_usec_changed_status) + "</p>";
      if (response.timer_left_usec > 0) {
        document.querySelector("#display").innerHTML += '<p><strong>4、倒计时总计(分):</strong> ' + usec_to_hour_min_sec(response.default_time_usec_delta) + "</p>";
        document.querySelector("#display").innerHTML += '<p><strong>5、倒计时剩余(分):</strong> ' + usec_to_hour_min_sec(response.timer_left_usec) + "</p>";
      }      
    })

    client.on('connect', function (connack) {
      console.log('Connected');
      document.querySelector("#display").innerText = '已经连接到mqtt服务器...';
    })

    client.on('reconnect', () => {
      console.log('Reconnecting...')
      document.querySelector("#display").innerText = 'Reconnecting...';
    })

    client.on('close', function () {
      console.log('Disconnected');
      document.querySelector("#display").innerText = 'Disconnected';
    })

    client.on('disconnect', function (packet) {
      console.log(packet)
    })

    client.on('offline', function () {
      console.log('offline');
      document.querySelector("#display").innerText = 'offline';
    })

    client.on('error', (err) => {
      console.log('Connection error: ', err)
      document.querySelector("#display").innerText = 'Connection error: ' + err;
      client.end()
    })

    function publish_mac_address(topic,payload) {
        client.publish(topic, payload, { qos: 0, retain: false }, function (error) {
          if (error) {
            console.log(error)
          } else {
            console.log('Published:',payload);
            document.querySelector("#display").innerText = '消息发布成功: ' + payload + "\n";
          }
        })
    }

    function set_timer() {
      var time_to_set_min = document.querySelector("#timer_input").value;
      publish_mac_address('kimkat_and_gobaba_pin_set_timer_min', time_to_set_min);
    }

    function usec_to_hour_min_sec(usec){
            return Math.floor(usec/(60*60*1000*1000))+" 时 " + Math.floor((usec/(1000*1000*60))%60) + " 分" + Math.floor((usec/(1000*1000))%60) + " 秒";
    }
</script>
</body>
</html>

