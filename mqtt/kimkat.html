<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="rebots" content="noindex,nofollow"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>mqtt</title>
  <script src="mqtt.min.js"></script>
  <style type="text/css">
    .btn {
      margin-top: 10px;
      margin-left: 10px;
      min-width: 150px;
      min-height: 35px;
    }

    .btn_ipv6 {
      margin-top: 10px;
      margin-left: 10px;
      min-width: 150px;
      min-height: 35px;
    }

  </style>
</head>
<body>
      <h3 id="display_ipv6_time">物联网mqtt消息发布/订阅平台</h3>
      <h4 style="color:blue;" id="display_ipv6">wss://broker.emqx.io:8084/mqtt</h4>
      <div>
        <input type="button" class="btn" value="打开Sama电脑" onclick="publish_message('kimkat_and_gobaba_wake_on_lan_mac', '00-E0-4C-66-67-DE');">
      </div>
      <div>
        <input type="button" class="btn" value="打开Lenovo电脑" onclick="publish_message('kimkat_and_gobaba_wake_on_lan_mac', '98-EE-CB-9B-2A-02');">
      </div>
      <div>
        <input type="button" class="btn" value="打开Dell电脑" onclick="publish_message('kimkat_and_gobaba_wake_on_lan_mac', 'A4-1F-72-4D-B5-97');">
      </div>
      <div>
        <input type="button" class="btn" value="测试一下" onclick="publish_message('kimkat_and_gobaba_wake_on_lan_mac', '00-00-00-00-00-00');">
      </div>
      <div>
        <input type="button" class="btn" value="获取地址" onclick="subscribe_topic('kimkat_and_gobaba_get_ipv6_response/#');">
      </div>
      <div id = "display" style="margin-top: 20px;margin-left: 10px;"></div>
<script>
    const clientId = 'mqttjs_' + Math.random().toString(16).substr(2, 8)
    const host = 'wss://broker.emqx.io:8084/mqtt'
    const options = {
      keepalive: 60*10,
      clientId: clientId,
      protocolId: 'MQTT',
      protocolVersion: 4,
      clean: true,
      reconnectPeriod: 1000,
      connectTimeout: 30 * 1000,
      will: {
        topic: 'WillMsg',
        payload: 'Connection Closed abnormally..!',
        qos: 0,
        retain: true
      },
    }
    console.log('Connecting mqtt client')
    var ipv6_map = new Map();
    const client = mqtt.connect(host, options);

    var topics_subsribe = ['kimkat_and_gobaba_wake_on_lan_mac_response','kimkat_and_gobaba_get_ipv6_response'];
    var topics_subsribed = [];

    topics_subsribe.forEach(function(e){
        client.subscribe(e, { qos: 0 }, function (error, granted) {
        if (error) {
          console.log(error);
        } else {
          console.log(`${granted[0].topic} was subscribed`);
          topics_subsribed.push(e);
        }
        });
    });

    client.on('message', function (topic, payload, packet) {
        if(topic == topics_subsribe[0]){
            console.log(`Topic: ${topic}, Message: ${payload.toString()}, QoS: ${packet.qos}`);
            document.querySelector("#display").innerText += '\n收到消息: ' + payload.toString();
        }else if(topic.split("/")[0] == topics_subsribe[1]){
          console.log(payload.toString())
          var response = JSON.parse(payload.toString());
          ipv6_map.set(topic,response);
          var new_content = "";
          ipv6_map.forEach(function(e){
              var passedMin = parseInt((Date.parse(new Date())/1000 - e['time_sec'])/60);
              var dateObj = new Date(e["time_sec"]*1000);
              var dateObj_str = format_date(dateObj);
              new_content += "<p><button class=\"btn_ipv6\" value=\""+ e["ipv6"] + "/" + dateObj_str +"\" onclick=\"copy_function(this);\">"+ e['client_id'] + "~"+ passedMin+"</button></p>";
            });
          document.querySelector("#display").innerHTML = new_content;
        }
    })

    client.on('connect', function (connack) {
      console.log('Connected');
      document.querySelector("#display").innerText = '已经连接到mqtt服务器...';
    })

    client.on('reconnect', () => {
      console.log('Reconnecting...')
      document.querySelector("#display").innerText = 'Reconnecting...';
    })

    client.on('close', function () {
      console.log('Disconnected');
      document.querySelector("#display").innerText = 'Disconnected';
    })

    client.on('disconnect', function (packet) {
      console.log(packet)
    })

    client.on('offline', function () {
      console.log('offline');
      document.querySelector("#display").innerText = 'offline';
    })

    client.on('error', (err) => {
      console.log('Connection error: ', err)
      document.querySelector("#display").innerText = 'Connection error: ' + err;
      client.end()
    })

    function publish_message(topic,payload) {
        client.publish(topic, payload, { qos: 0, retain: false }, function (error) {
          if (error) {
            console.log(error)
          } else {
            console.log('Published:',payload);
            document.querySelector("#display").innerText = '消息发布成功: ' + payload;
          }
        })
    }

    function subscribe_topic(topic){
      if (topics_subsribed.indexOf(topic) == -1) {
          client.subscribe(topic, { qos: 0 }, function (error, granted) {
            if (error) {
              console.log(error);
            } else {
              console.log(`${granted[0].topic} was subscribed`);
              topics_subsribed.push(topic);
            }
            });
      }
    }
</script>

<script>
  function copy_function(obj) {
      let content = obj.value;
      navigator.clipboard.writeText(content.split("/")[0]);
      document.querySelector("#display_ipv6").innerHTML = content.split("/")[0];
      document.querySelector("#display_ipv6_time").innerHTML = content.split("/")[1];
      document.querySelectorAll(".btn_ipv6").forEach(function (e){
          e.style.color='blue';
      });
      obj.style = "color:red;"
  }

function format_date_yyyy_mm_dd(dateTime){
        var year = dateTime.getFullYear();
        var month = dateTime.getMonth() + 1;
        var day = dateTime.getDate();
        return year + "-" + month.toString().padStart(2, '0')  + "-" + day.toString().padStart(2, '0');
}

function format_date(dateTime){
        let datelist = ['周日','周一','周二','周三','周四','周五','周六',]
        var year = dateTime.getFullYear();
        var month = dateTime.getMonth() + 1;
        var day = dateTime.getDate();
        var weekday = dateTime.getDay();
        var hours = dateTime.getHours();
        var minutes = dateTime.getMinutes();
        // var seconds = dateTime.getSeconds();
        return year + "-" + month.toString().padStart(2, '0')  + "-" + day.toString().padStart(2, '0') +"&nbsp"+datelist[weekday]+ "&nbsp"+ hours.toString().padStart(2, '0') + ':' +  minutes.toString().padStart(2, '0');
}
  </script>
</body>
</html>

