<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>mqtt</title>
  <script src="mqtt.min.js"></script>
  <style type="text/css">
    .btn {
      margin-top: 10px;
      margin-left: 10px;
      min-width: 150px;
      min-height: 35px;
    }
    .text {
      margin-top: 10px;
      margin-left: 10px;
      min-width: 30px;
      min-height: 25px;
      max-width: 75px;
      text-align: center;
    }

  </style>
</head>
<body>
      <h4 style="color:black;">wss://broker.emqx.io:8084/mqtt</h4>
      <input type="button" class="btn" value="更新状态" onclick="publish_message('kimkat_and_gobaba_light_status', '正在获取数据,请稍等...');">
      <div id = "display" style="margin-top: 20px;margin-left: 10px;"></div>
<script>
    const clientId = 'mqttjs_' + Math.random().toString(16).substr(2, 8)
    const host = 'wss://broker.emqx.io:8084/mqtt'
    const options = {
      keepalive: 60*3,
      clientId: clientId,
      protocolId: 'MQTT',
      protocolVersion: 4,
      clean: true,
      reconnectPeriod: 1000,
      connectTimeout: 30 * 1000,
      will: {
        topic: 'WillMsg',
        payload: 'Connection Closed abnormally..!',
        qos: 0,
        retain: false
      },
    }
    console.log('Connecting mqtt client')
    const client = mqtt.connect(host, options);

    client.subscribe('kimkat_and_gobaba_light_status_response', { qos: 0 }, function (error, granted) {
      if (error) {
        console.log(error);
      } else {
        console.log(`${granted[0].topic} was subscribed`);
      }
    })

    client.on('message', function (topic, payload, packet) {
      console.log(`Topic: ${topic}, Message: ${payload.toString()}, QoS: ${packet.qos}`);
      var response = JSON.parse(payload.toString());
      var uptime_useconds = response["uptime"];
      var uptime_seconds = uptime_useconds/(1000*1000);
      var uptime_minutes = uptime_seconds/60;
      var uptime_hours = uptime_minutes/60;
      var uptime_str = parseInt(uptime_hours).toString().padStart(2, '0') + ":" + parseInt(uptime_minutes%60).toString().padStart(2, '0') + ":" + parseInt(uptime_seconds%60).toString().padStart(2, '0');
      document.querySelector("#display").innerHTML = "<p><font style='color:blue;'>开机时间:&nbsp</font>" +  uptime_str +"</p>"; 
      document.querySelector("#display").innerHTML += "<p><font style='color:blue;'>空闲内存(bytes):&nbsp</font>" +  response["freeheapsize"] +"</p>";
      document.querySelector("#display").innerHTML += "<p><font style='color:blue;'>当前亮度:&nbsp</font>" +  response["brightness"].toFixed(6) +"</p>"; 
      document.querySelector("#display").innerHTML += "<p><font style='color:blue;'>5分钟内触发次数:&nbsp</font>" +  response["risingtimes"] +"</p>";


      var data = response['data'];
      var date = new Date();
      var mseconds = Date.parse(date);
      var temp_date_str = "";
      for (var i = 0; i < data.length; i++) {
        var item = data[i];
        var time_useconds = item[0];        
        var passed_useconds = uptime_useconds - time_useconds;
        var temp_mseconds = mseconds - passed_useconds/1000;
        var dateObj = new Date(temp_mseconds);
        var dateObj_str = format_date_yyyy_mm_dd(dateObj);
        if (temp_date_str != dateObj_str) {
          document.querySelector("#display").innerHTML += "<hr>";
          temp_date_str = dateObj_str;
        }
        var timeString = format_date(dateObj);
        var brightness_delta = Math.abs(item[2] - item[1]);

        if (item[1] < item[2]) {
          if (item[1] > 0) {
            if(brightness_delta>3000){
              document.querySelector("#display").innerHTML += "<p><font style='color:green;'>" + timeString + "&nbsp&nbsp开灯&nbsp+"+ parseInt(brightness_delta/100) +"</font></p>";
            }else{
              document.querySelector("#display").innerHTML += "<p><font style='color:green;'>" + timeString + "&nbsp&nbsp亮度&nbsp+"+ parseInt(brightness_delta/100) +"</font></p>";
            }
            
          }else{
            document.querySelector("#display").innerHTML += "<p><font style='color:black;'>" + timeString + "&nbsp&nbsp开始检测!</font></p>";
          }           
        }else{

          if (brightness_delta>3000) {
            document.querySelector("#display").innerHTML += "<p><font style='color:red;'>"  + timeString + "&nbsp&nbsp关灯&nbsp-"+ parseInt(brightness_delta/100) +"</font></p>";
          }else{
            document.querySelector("#display").innerHTML += "<p><font style='color:red;'>"  + timeString + "&nbsp&nbsp亮度&nbsp-"+ parseInt(brightness_delta/100) +"</font></p>";
          }           
        }
      }
    })


function format_date_yyyy_mm_dd(dateTime){
        var year = dateTime.getFullYear();
        var month = dateTime.getMonth() + 1;
        var day = dateTime.getDate();
        return year + "-" + month.toString().padStart(2, '0')  + "-" + day.toString().padStart(2, '0');
}

function format_date(dateTime){
        let datelist = ['周日','周一','周二','周三','周四','周五','周六',]
        var year = dateTime.getFullYear();
        var month = dateTime.getMonth() + 1;
        var day = dateTime.getDate();
        var weekday = dateTime.getDay();
        var hours = dateTime.getHours();
        var minutes = dateTime.getMinutes();
        // var seconds = dateTime.getSeconds();
        return year + "-" + month.toString().padStart(2, '0')  + "-" + day.toString().padStart(2, '0') +"&nbsp"+datelist[weekday]+ "&nbsp"+ hours.toString().padStart(2, '0') + ':' +  minutes.toString().padStart(2, '0');
}

    client.on('connect', function (connack) {
      console.log('Connected');
      document.querySelector("#display").innerText = '已经连接到mqtt服务器...';
      publish_message("kimkat_and_gobaba_light_status","status");
    })

    client.on('reconnect', () => {
      console.log('Reconnecting...')
      document.querySelector("#display").innerText = 'Reconnecting...';
    })

    client.on('close', function () {
      console.log('Disconnected');
      document.querySelector("#display").innerText = 'Disconnected';
    })

    client.on('disconnect', function (packet) {
      console.log(packet)
    })

    client.on('offline', function () {
      console.log('offline');
      document.querySelector("#display").innerText = 'offline';
    })

    client.on('error', (err) => {
      console.log('Connection error: ', err)
      document.querySelector("#display").innerText = 'Connection error: ' + err;
      client.end()
    })

    client.publish("kimkat_and_gobaba_wake_on_light", "start...", { qos: 0, retain: false }, function (error) {
      if (error) {
        console.log(error)
      }
    })

    function publish_message(topic,payload) {
        client.publish(topic, payload, { qos: 0, retain: false }, function (error) {
          if (error) {
            console.log(error)
          } else {
            console.log('Published:',payload);
            document.querySelector("#display").innerText = '消息发布成功: ' + payload;
          }
        })
    }

</script>
</body>
</html>

